<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Business Card Details Extractor</title>
  <style>
    body { background-color: #f0f0f0; font-family: Arial, sans-serif; padding: 30px; }
    h1 { text-align: center; color: #333; margin-bottom: 20px; }

    #frame {
      width: 500px; height: 300px;
      margin: 0 auto 20px auto;
      border: 4px double #333;
      border-radius: 8px;
      display: flex; justify-content: center; align-items: center;
      background: #fff;
    }
    #frame img, #frame video { max-width: 100%; max-height: 100%; border-radius: 6px; }

    form { text-align: center; margin-bottom: 20px; }
    input[type=file], button, input[type=submit] {
      padding: 10px; margin: 5px; border-radius: 5px; cursor: pointer; font-weight: bold;
    }
    input[type=file] { background-color: #808080; color: white; border: none; }
    button { background-color: #FFD700; border: none; }
    input[type=submit] { background-color: #333; color: white; border: none; padding: 10px 20px; }
    input[type=submit]:hover { background-color: #555; }

    .container { display: flex; justify-content: space-between; gap: 20px; margin-top: 30px; }
    .card, .results { flex: 1; background: white; padding: 20px; border-radius: 8px; box-shadow: 0px 4px 8px rgba(0,0,0,0.1); }
    .card img { max-width: 100%; border-radius: 8px; }
  </style>
</head>
<body>
  <h1><i>Business Card Details Extractor</i></h1>

  <!-- Display area -->
  <div id="frame">
    <!-- Persist uploaded/captured image after extraction -->
    {% if uploaded_base64 %}
      <img id="persisted" src="data:image/png;base64,{{ uploaded_base64 }}" alt="Captured/Uploaded Image">
    {% endif %}

    <!-- Live preview elements (always present, toggled by JS) -->
    <img id="preview" src="" alt="Preview" style="display:none;">
    <video id="video" width="500" height="300" autoplay style="display:none;"></video>
    <canvas id="canvas" width="500" height="300" style="display:none;"></canvas>
  </div>

  <!-- Upload Form -->
  <form id="mainForm" method="post" enctype="multipart/form-data">
    <input type="file" name="file" id="fileInput" accept=".png,.jpg,.jpeg,.pdf">
    <button type="button" id="capture">Capture</button>
    <button type="button" id="takePicture" style="display:none;">Take Picture</button>
    <button type="button" id="retake" style="display:none;">Retake</button>
    <input type="hidden" name="camera_image" id="camera_image">
    <input type="submit" value="Extract" style="display:none;" id="extractBtn">
  </form>

  <!-- Results (image or PDF) -->
  {% if annotated_base64 or entities %}
  <div class="container">
    <div class="card">
      <h2>Annotated Card</h2>
      <img src="data:image/png;base64,{{ annotated_base64 }}" alt="Annotated Card">
    </div>
    <div class="results">
      <h2>Extracted Information</h2>
      <ul>
        <li><strong>Name:</strong> {{ entities["Name"]|join(", ") if entities["Name"] else "Not found" }}</li>
        <li><strong>Job Title:</strong> {{ entities["Job Title"]|join(", ") if entities["Job Title"] else "Not found" }}</li>
        <li><strong>Address:</strong> {{ entities["Address"]|join(", ") if entities["Address"] else "Not found" }}</li>
        <li><strong>Phone:</strong> {{ entities["Phone"]|join(", ") if entities["Phone"] else "Not found" }}</li>
        <li><strong>Email:</strong> {{ entities["Email"]|join(", ") if entities["Email"] else "Not found" }}</li>
        <li><strong>Website:</strong> {{ entities["Website"]|join(", ") if entities["Website"] else "Not found" }}</li>
      </ul>
    </div>
  </div>
  {% endif %}

  {% if pdf_results %}
    {% for page, data in pdf_results.items() %}
    <h2>{{ page }}</h2>
    <div class="container">
      <div class="card">
        <h3>Original Page</h3>
        <img src="data:image/png;base64,{{ data.uploaded_base64 }}" alt="Original Page">
      </div>
      <div class="card">
        <h3>Annotated Page</h3>
        <img src="data:image/png;base64,{{ data.annotated_base64 }}" alt="Annotated Page">
      </div>
      <div class="results">
        <h3>Extracted Information</h3>
        <ul>
          <li><strong>Name:</strong> {{ data.entities["Name"]|join(", ") if data.entities["Name"] else "Not found" }}</li>
          <li><strong>Job Title:</strong> {{ data.entities["Job Title"]|join(", ") if data.entities["Job Title"] else "Not found" }}</li>
          <li><strong>Address:</strong> {{ data.entities["Address"]|join(", ") if data.entities["Address"] else "Not found" }}</li>
          <li><strong>Phone:</strong> {{ data.entities["Phone"]|join(", ") if data.entities["Phone"] else "Not found" }}</li>
          <li><strong>Email:</strong> {{ data.entities["Email"]|join(", ") if data.entities["Email"] else "Not found" }}</li>
          <li><strong>Website:</strong> {{ data.entities["Website"]|join(", ") if data.entities["Website"] else "Not found" }}</li>
        </ul>
      </div>
    </div>
    {% endfor %}
  {% endif %}

  <script>
    window.onload = function() {
      let stream;
      const video = document.getElementById("video");
      const preview = document.getElementById("preview");
      const captureBtn = document.getElementById("capture");
      const takeBtn = document.getElementById("takePicture");
      const retakeBtn = document.getElementById("retake");
      const extractBtn = document.getElementById("extractBtn");

      // File upload preview
      document.getElementById("fileInput").addEventListener("change", function(e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(evt) {
            preview.src = evt.target.result;
            preview.style.display = "block";
            video.style.display = "none";
          };
          reader.readAsDataURL(file);
          extractBtn.style.display = "inline-block";
        }
      });

      // Capture camera feed
      captureBtn.addEventListener("click", async () => {
        try {
          stream = await navigator.mediaDevices.getUserMedia({ video: true });
          video.srcObject = stream;
          video.style.display = "block";
          await video.play();

          preview.style.display = "none";
          const persisted = document.getElementById("persisted");
          if (persisted) persisted.style.display = "none";

          takeBtn.style.display = "inline-block";
          retakeBtn.style.display = "none";
          extractBtn.style.display = "none";
        } catch (err) {
          alert("Camera error: " + err);
        }
      });
      // Take picture
      takeBtn.addEventListener("click", () => {
        const canvas = document.getElementById("canvas");
        const ctx = canvas.getContext("2d");
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        const dataURL = canvas.toDataURL("image/png");
        document.getElementById("camera_image").value = dataURL;

        preview.src = dataURL;
        preview.style.display = "block";

        if (stream) stream.getTracks().forEach(track => track.stop());
        video.srcObject = null;
        video.style.display = "none";

        takeBtn.style.display = "none";
        retakeBtn.style.display = "inline-block";
        extractBtn.style.display = "inline-block";
      });

      // Retake picture
      retakeBtn.addEventListener("click", async () => {
        try {
          stream = await navigator.mediaDevices.getUserMedia({ video: true });
          video.srcObject = stream;
          video.style.display = "block";
          await video.play();
          preview.style.display = "none";
                    takeBtn.style.display = "inline-block";
          retakeBtn.style.display = "none";
          extractBtn.style.display = "none";
        } catch (err) {
          alert("Camera error: " + err);
        }
      });

      // Retake picture
      retakeBtn.addEventListener("click", async () => {
        try {
          stream = await navigator.mediaDevices.getUserMedia({ video: true });
          video.srcObject = stream;
          video.style.display = "block";
          await video.play();
          preview.style.display = "none";

          takeBtn.style.display = "inline-block";
          retakeBtn.style.display = "none";
          extractBtn.style.display = "none";
        } catch (err) {
          alert("Camera error: " + err);
        }
      });
    };
  </script>
</body>
</html>